From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Paul Sauve <paul@technove.co>
Date: Mon, 26 Apr 2021 11:20:12 -0500
Subject: [PATCH] Reduce frequency of checking for entity despawn

This isn't a great way to deal with this, but at a high number of
entities this starts adding up more than it should, and it's already
fairly optimized. Just starts being slow when you have 30k entities.

diff --git a/src/main/java/gg/airplane/AirplaneConfig.java b/src/main/java/gg/airplane/AirplaneConfig.java
index e22ccbe13a252b9406c02d5c516b245d5ff57a0f..3c13ee6b907add5fbb51f6955020b6bc3ac28c6f 100644
--- a/src/main/java/gg/airplane/AirplaneConfig.java
+++ b/src/main/java/gg/airplane/AirplaneConfig.java
@@ -109,4 +109,13 @@ public class AirplaneConfig {
     }
 
 
+    public static byte entityDespawnCheckFrequency;
+
+    private static void entitySettings() {
+        config.setComment("entities", "Configures settings for generic entities");
+
+        entityDespawnCheckFrequency = (byte) Math.max(config.getInt("entities.despawn-check-freq", 8), Byte.MAX_VALUE);
+    }
+
+
 }
diff --git a/src/main/java/net/minecraft/world/entity/Mob.java b/src/main/java/net/minecraft/world/entity/Mob.java
index af4fbbc023c7c1837a3e033d1c7290156e9014ae..4e5344288db1f75e3d01a38378da9ffd5ecfd727 100644
--- a/src/main/java/net/minecraft/world/entity/Mob.java
+++ b/src/main/java/net/minecraft/world/entity/Mob.java
@@ -816,8 +816,15 @@ public abstract class Mob extends LivingEntity {
         return false;
     }
 
+    // Airplane start - just reduce frequency of checking for despawn
+    private byte despawnCheck = 0;
     @Override
     public void checkDespawn() {
+        if (++despawnCheck < gg.airplane.AirplaneConfig.entityDespawnCheckFrequency) {
+            return;
+        }
+        this.despawnCheck = 0;
+        // Airplane end
         if (this.level.getDifficulty() == Difficulty.PEACEFUL && this.shouldDespawnInPeaceful()) {
             this.discard();
         } else if (!this.isPersistenceRequired() && !this.requiresCustomPersistence()) {
